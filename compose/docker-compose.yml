version: '3.7'

services: 
    app:
        image: magento-nginx:1.17
        build: ./images/nginx/1.17
        ports: 
            - "80:8080"
            - "443:8443"
        environment: 
            - HOSTNAME=l.m2.com
        links:
            - db
            - phpfpm
        volumes: &appvolumes
            - ~/.composer:/var/www/.composer:delegated
            - appdata:/var/www/html
#            - ./../html:/var/www/html
            - ./../html/app/code:/var/www/html/app/code:delegated
            - ./../html/app/design:/var/www/html/app/design:delegated
            - ./../html/app/etc:/var/www/html/app/etc:delegated
            - ./../html/var/log:/var/www/html/var/log:delegated
            - ./../html/composer.json:/var/www/html/composer.json:delegated
            - ./../html/composer.lock:/var/www/html/composer.lock:delegated
            - ./../html/nginx.conf.sample:/var/www/html/nginx.conf:delegated
            - sockdata:/sock

    phpfpm:
        image: magento-php:7.3-fpm-2
        build: ./images/php/7.3
        links:
            - db
        volumes: *appvolumes

    db:
        image: percona:5.7
        ports:
            - "3306:3306"
        env_file: env/db.env
        volumes: 
            - dbdata:/var/lib/mysql

    redis:
        image: redis:5.0

#    elasticsearch:
#        image: magento-elasticsearch:6.5.4-0
#        build: ./images/elasticsearch/6.5
#        ports:
#            - "9200:9200"
#            - "9300:9300"

volumes:
    appdata:
    dbdata:
    sockdata: