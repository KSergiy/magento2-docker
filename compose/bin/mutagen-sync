#!/bin/bash

# Read data from .env file
CONFIG_SRC=$(cd -P "./../compose" && pwd)
PROJECT_SRC=$(cd -P "./../html" && pwd)
export $(xargs < $CONFIG_SRC/.env)

BIN_SRC="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
if [ $# -gt 0 ]; then
    if [ "$1" = "up" ]; then
        shift 1
        docker-compose -f $BIN_SRC/../docker-compose.yml up -d

        mutagen daemon start
        mutagen sync create \
            --name=app \
            --sync-mode=two-way-resolved \
            --ignore=$PROJECT_SRC/.idea \
            --ignore=$PROJECT_SRC/.github \
            --ignore=$PROJECT_SRC/pub/static \
            --ignore=$PROJECT_SRC/var/view_preprocessed \
            --ignore=$PROJECT_SRC/var/session \
            --ignore=$PROJECT_SRC/var/debug \
            --ignore=$PROJECT_SRC/var/cache \
            --watch-mode-alpha=no-watch \
            --symlink-mode=posix-raw \
            --ignore-vcs \
            $PROJECT_SRC docker://app@$PROJECT_NAME-app/var/www/html
    elif [ "$1" = "down" ]; then
        mutagen terminate $PROJECT_NAME
        mutagen daemon stop
        docker-compose -f $BIN_SRC/../docker-compose.yml down --remove-orphans
    fi
fi